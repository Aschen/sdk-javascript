/*! Kuzzle javascript SDK version 5.0.15 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Kuzzle=t():e.Kuzzle=t()}(window,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=6)}([function(e,t){function r(e,t,r,n){if(!t)throw new Error("A security document must have an id");if(Object.defineProperties(this,{kuzzle:{value:e.kuzzle},Security:{value:e},id:{value:t,enumerable:!0},content:{value:{},writable:!0,enumerable:!0},meta:{value:n||{},writable:!0,enumerable:!0}}),r&&this.setContent(r,!0),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["delete","update"].indexOf(e)}})}r.prototype.setContent=function(e){return this.content=e,this},r.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),e.body=this.content,e.meta=this.meta,e},r.prototype.delete=function(e,t){e&&void 0===t&&"function"==typeof e&&(t=e,e=null),this.kuzzle.query(this.Security.buildQueryArgs(this.deleteActionName),{_id:this.id},e,function(e,r){if(e)return!!t&&t(e);t&&t(null,r.result._id)})},r.prototype.update=function(e,t,r){var n={},i=this;if("object"!=typeof e)throw new Error('Parameter "content" must be a object');return t&&void 0===r&&"function"==typeof t&&(r=t,t=null),n._id=i.id,n.body=e,i.kuzzle.query(this.Security.buildQueryArgs(this.updateActionName),n,t,function(e,t){if(e)return!!r&&r(e);i.setContent(t.result._source),r&&r(null,i)}),this},e.exports=r},function(e,t,r){var n=r(7),i=r(8);e.exports=function(e,t,r){var o=t&&r||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var s=(e=e||{}).random||(e.rng||n)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t)for(var u=0;u<16;++u)t[o+u]=s[u];return t||i(s)}},function(e,t,r){function n(){"undefined"!=typeof window&&(this._events={},this._onceEvents={})}"undefined"==typeof window?(n.prototype=r(9).prototype,n.prototype.constructor=n):(n.prototype.on=function(e,t){var r,n=typeof t;if(e&&t){if("function"!==n)throw new Error("Invalid listener type: expected a function, got a "+n);return-1===(r=this.listeners(e)).indexOf(t)&&r.push(t),this.emit("newListener",e,t),this}},n.prototype.addListener=n.prototype.on,n.prototype.prependListener=function(e,t){var r;if(e&&t)return-1===(r=this.listeners(e)).indexOf(t)&&(this._events[e]=new Array(t).concat(r)),this.emit("newListener",e,t),this},n.prototype.once=function(e,t){if(e&&t)return this.on(e,t),(this._onceEvents[e]=this._onceEvents[e]||{})[t]=!0,this},n.prototype.prependOnceListener=function(e,t){if(e&&t)return this.prependListener(e,t),(this._onceEvents[e]=this._onceEvents[e]||{})[t]=!0,this},n.prototype.removeListener=function(e,t){var r,n=this._events[e];if(n&&n.length)return-1!==(r=n.indexOf(t))&&n.splice(r,1),0===n.length&&delete this._events[e],this.emit("removeListener",e,t),this},n.prototype.removeAllListeners=function(e){return e?(delete this._events[e],delete this._onceEvents[e]):(this._events=[],this._onceEvents=[]),this},n.prototype.emit=function(e){var t,r,n,i,o=0;if((t=this._events&&this._events[e])&&t.length){for(r=Array.prototype.slice.call(arguments,1),n=this._onceEvents&&this._onceEvents[e]||{},i=new Array,listener=t[o];listener;)i.push(listener),n[listener]?(this.removeListener(e,listener),delete n[listener]):o++,listener=t[o];for(item in i)void 0!==i[item]&&i[item].apply(this,r);return this}},n.prototype.eventNames=function(){return Object.keys(this._events)},n.prototype.listenerCount=function(e){return this._events[e]&&this._events[e].length||0},n.prototype.listeners=function(e){return void 0===this._events[e]&&(this._events[e]=[]),this._events[e]}),n.prototype.emitEvent=n.prototype.emit,n.prototype.off=n.prototype.removeListener,e.exports=n},function(e,t){function r(e,t,r,n){return Object.defineProperties(this,{collection:{value:e.collection,enumerable:!0},dataCollection:{value:e,enumerable:!1},kuzzle:{value:e.kuzzle,enumerable:!1},id:{value:void 0,enumerable:!0,writable:!0},content:{value:{},writable:!0,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0},version:{value:void 0,enumerable:!0,writable:!0},meta:{value:n||{},enumerable:!0,writable:!1}}),!r&&t&&"object"==typeof t&&(r=t,t=null),r&&(r._version&&(this.version=r._version,delete r._version),this.setContent(r,!0)),t&&Object.defineProperty(this,"id",{value:t,enumerable:!0}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["delete","refresh","save"].indexOf(e)}}):this}r.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),this.version&&(e._version=this.version),e.body=this.content,e.meta=this.meta,e=this.kuzzle.addHeaders(e,this.headers)},r.prototype.toString=function(){return JSON.stringify(this.serialize())},r.prototype.delete=function(e,t){var r=this;if(t||"function"!=typeof e||(t=e,e=null),!r.id)throw new Error("Document.delete: cannot delete a document without a document ID");this.kuzzle.query(this.dataCollection.buildQueryArgs("document","delete"),this.serialize(),e,t&&function(e){t(e,e?void 0:r.id)})},r.prototype.exists=function(e,t){if(t||"function"!=typeof e||(t=e,e=null),!this.id)throw new Error("Document.exists: cannot check if the document exists if no id has been provided");this.kuzzle.query(this.dataCollection.buildQueryArgs("document","exists"),this.serialize(),e,t&&function(e,r){t(e,e?void 0:r.result)})},r.prototype.refresh=function(e,t){var n=this;if(t||"function"!=typeof e||(t=e,e=null),!n.id)throw new Error("Document.refresh: cannot retrieve a document if no ID has been provided");this.kuzzle.callbackRequired("Document.refresh",t),n.kuzzle.query(n.dataCollection.buildQueryArgs("document","get"),{_id:n.id},e,function(e,i){var o;if(e)return t(e);(o=new r(n.dataCollection,n.id,i.result._source,i.result._meta)).version=i.result._version,t(null,o)})},r.prototype.save=function(e,t){var r=this.serialize(),n=r._id?"createOrReplace":"create",i=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),i.kuzzle.query(this.dataCollection.buildQueryArgs("document",n),r,e,function(e,r){if(e)return t&&t(e);i.id=r.result._id,i.version=r.result._version,t&&t(null,i)}),i},r.prototype.publish=function(e){var t=this.serialize();return this.kuzzle.query(this.dataCollection.buildQueryArgs("realtime","publish"),t,e),this},r.prototype.setContent=function(e,t){var r=this;return t?this.content=e:Object.keys(e).forEach(function(t){r.content[t]=e[t]}),this},r.prototype.subscribe=function(e,t){var r;if(e&&!t&&"function"==typeof e&&(t=e,e=null),this.kuzzle.callbackRequired("Document.subscribe",t),!this.id)throw new Error("Document.subscribe: cannot subscribe to a document if no ID has been provided");return r={ids:{values:[this.id]}},this.dataCollection.subscribe(r,e,t)},r.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=r},function(e,t,r){var n=r(0);function i(e,t,r,i){if(n.call(this,e,t,r,i),Object.defineProperties(this,{deleteActionName:{value:"deleteUser"},updateActionName:{value:"updateUser"},credentials:{value:{},writable:!0,enumerable:!0}}),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["create","replace","saveRestricted","update","getProfiles"].indexOf(e)}})}i.prototype=Object.create(n.prototype,{constructor:{value:i}}),i.prototype.setProfiles=function(e){if(!Array.isArray(e)||"string"!=typeof e[0])throw new Error('Parameter "profileIds" must be an array of strings');return this.content.profileIds=e,this},i.prototype.setCredentials=function(e){if("object"!=typeof e)throw new Error('Parameter "credentials" must be a object');return this.credentials=e,this},i.prototype.addProfile=function(e){if("string"!=typeof e)throw new Error('Parameter "profileId" must be a string');return this.content.profileIds||(this.content.profileIds=[]),-1===this.content.profileIds.indexOf(e)&&this.content.profileIds.push(e),this},i.prototype.create=function(e,t){var r=this.creationSerialize(),n=this;if(!this.content.profileIds)throw new Error('Argument "profileIds" is mandatory in a user. This argument contains an array of profile identifiers.');return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),this.kuzzle.query(this.Security.buildQueryArgs("createUser"),r,null,t&&function(e){t(e,e?void 0:n)}),this},i.prototype.replace=function(e,t){var r=this.serialize(),n=this;if(!this.content.profileIds)throw new Error('Argument "profileIds" is mandatory in a user. This argument contains an array of profile identifiers.');return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),this.kuzzle.query(this.Security.buildQueryArgs("replaceUser"),r,null,t&&function(e){t(e,e?void 0:n)}),this},i.prototype.saveRestricted=function(e,t){var r=this.serialize(),n=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),n.kuzzle.query(this.Security.buildQueryArgs("createRestrictedUser"),r,e,t&&function(e){t(e,e?void 0:n)}),n},i.prototype.serialize=function(){return{_id:this.id,body:this.content,meta:this.meta}},i.prototype.creationSerialize=function(){return{_id:this.id,body:{content:this.content,credentials:this.credentials,meta:this.meta}}},i.prototype.getProfileIds=function(){return this.content.profileIds||[]},i.prototype.getProfiles=function(e,t){var r=this,n=[],i=!1;if(e&&!t&&"function"==typeof e&&(t=e,e=null),r.Security.kuzzle.callbackRequired("User.getProfiles",t),!r.content.profileIds)return t(null,n);r.content.profileIds.forEach(function(o){r.Security.fetchProfile(o,e,function(e,o){if(e){if(i)return;return i=!0,t(e)}n.push(o),n.length===r.content.profileIds.length&&t(null,n)})})},e.exports=i},function(e,t,r){var n=r(2);function i(e,t,i){var s=this;n.call(this),this.WebSocket="undefined"!=typeof WebSocket?WebSocket:r(!function(){var e=new Error("Cannot find module 'ws'");throw e.code="MODULE_NOT_FOUND",e}()),this.host=e,this.port=t,this.ssl=i,this.client=null,this.wasConnected=!1,this.retrying=!1,this.lasturl=null,this.stopRetryingToConnect=!1,this.connect=function(e,t){var r=(this.ssl?"wss://":"ws://")+this.host+":"+this.port,n="undefined"!=typeof window?void 0:{perMessageDeflate:!1};r!==this.lasturl&&(s.wasConnected=!1,this.lasturl=r),this.client=new this.WebSocket(r,n),this.client.onopen=function(){s.wasConnected?s.emitEvent("reconnect"):s.emitEvent("connect"),s.wasConnected=!0,s.stopRetryingToConnect=!1},this.client.onclose=function(r,n){var i,u,l=n;"number"==typeof r?u=r:(u=r.code,r.reason&&(l=r.reason)),1e3===u?s.emitEvent("disconnect"):((i=new Error(l)).status=u,o(s,e,t,i))},this.client.onerror=function(r){r instanceof Error||(r=new Error(r)),o(s,e,t,r)},this.client.onmessage=function(e){var t=JSON.parse(e.data||e);t.room?s.emitEvent(t.room,t):s.emitEvent("discarded",t)}},this.onConnect=function(e){this.addListener("connect",e)},this.onConnectError=function(e){this.addListener("networkError",e)},this.onDisconnect=function(e){this.addListener("disconnect",e)},this.onReconnect=function(e){this.addListener("reconnect",e)},this.send=function(e){this.client&&this.client.readyState===this.client.OPEN&&this.client.send(JSON.stringify(e))},this.close=function(){this.removeAllListeners(),this.wasConnected=!1,this.client.close(),this.client=null,s.stopRetryingToConnect=!0}}function o(e,t,r,n){!t||e.retrying||e.stopRetryingToConnect||(e.retrying=!0,setTimeout(function(){e.retrying=!1,e.connect(t,r)},r)),e.emitEvent("networkError",n)}i.prototype=Object.create(n.prototype),i.prototype.constructor=i,e.exports=i},function(e,t,r){var n=r(1),i=r(2),o=r(10),s=r(15),u=r(18),l=r(4),c=r(19);function a(e,t,r){var o=this;if(!(this instanceof a))return new a(e,t,r);if(i.call(this),r||"function"!=typeof t||(r=t,t=null),!e||""===e)throw new Error("host argument missing");return Object.defineProperties(this,{id:{value:n()},collections:{value:{},writable:!0},connectCB:{value:r},eventActions:{value:["connected","networkError","disconnected","reconnected","tokenExpired","loginAttempt","offlineQueuePush","offlineQueuePop","queryError","discarded"],writable:!1},queuing:{value:!1,writable:!0},state:{value:"initializing",writable:!0},subscriptions:{value:{pending:{}},writable:!0},autoReconnect:{value:!t||"boolean"!=typeof t.autoReconnect||t.autoReconnect,writable:!0,enumerable:!0},defaultIndex:{value:t&&"string"==typeof t.defaultIndex?t.defaultIndex:void 0,writable:!0,enumerable:!0},reconnectionDelay:{value:t&&"number"==typeof t.reconnectionDelay?t.reconnectionDelay:1e3,writable:!0,enumerable:!0},host:{value:e,writable:!0,enumerable:!0},port:{value:t&&"number"==typeof t.port?t.port:7512,enumerable:!0,writable:!0},sslConnection:{value:!(!t||"boolean"!=typeof t.sslConnection)&&t.sslConnection,writable:!0,enumerable:!0},autoQueue:{value:!1,enumerable:!0,writable:!0},autoReplay:{value:!1,enumerable:!0,writable:!0},autoResubscribe:{value:!0,enumerable:!0,writable:!0},headers:{value:{},enumerable:!0,writable:!0},volatile:{value:{},enumerable:!0,writable:!0},offlineQueue:{value:[],enumerable:!0,writable:!0},queueFilter:{value:null,enumerable:!0,writable:!0},queueMaxSize:{value:500,enumerable:!0,writable:!0},queueTTL:{value:12e4,enumerable:!0,writable:!0},replayInterval:{value:10,enumerable:!0,writable:!0},jwtToken:{value:void 0,enumerable:!0,writable:!0},offlineQueueLoader:{value:void 0,enumerable:!0,writable:!0},sdkVersion:{value:"5.0.15",writable:!1}}),t&&(Object.keys(t).forEach(function(e){o.hasOwnProperty(e)&&Object.getOwnPropertyDescriptor(o,e).writable&&(o[e]=t[e])}),"auto"===t.offlineMode&&this.autoReconnect&&(this.autoQueue=this.autoReplay=this.autoResubscribe=!0)),Object.defineProperty(this,"isValid",{value:function(){if("disconnected"===o.state)throw new Error("This Kuzzle object has been invalidated. Did you try to access it after a disconnect call?")}}),Object.defineProperty(this,"addHeaders",{value:function(e,t){return Object.keys(t).forEach(function(r){e[r]||(e[r]=t[r])}),e}}),Object.defineProperty(this,"callbackRequired",{value:function(e,t){if(!t||"function"!=typeof t)throw new Error(e+": a callback argument is required for read queries")}}),Object.defineProperty(this,"security",{value:new s(this),enumerable:!0}),Object.defineProperty(this,"memoryStorage",{value:new u(this),enumerable:!0}),Object.defineProperties(this,{eventTimeout:{value:t&&"number"==typeof t.eventTimeout?t.eventTimeout:200,writeable:!1}}),Object.defineProperty(this,"protectedEvents",{value:{connected:{timeout:this.eventTimeout},error:{timeout:this.eventTimeout},disconnected:{timeout:this.eventTimeout},reconnected:{timeout:this.eventTimeout},tokenExpired:{timeout:this.eventTimeout},loginAttempt:{timeout:this.eventTimeout}},writeable:!1}),t&&t.connect&&"auto"!==t.connect?this.state="ready":this.connect(),this.bluebird?this.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["getAllStatistics","getServerInfo","getStatistics","listCollections","createIndex","listIndexes","login","logout","now","query","checkToken","whoAmI","updateSelf","getMyRights","refreshIndex","getAutoRefresh","setAutoRefresh"].indexOf(e)}}):void 0}function f(){var e=this,t=Date.now(),r=-1;e.queueTTL>0&&(e.offlineQueue.forEach(function(n,i){n.ts<t-e.queueTTL&&(r=i)}),-1!==r&&e.offlineQueue.splice(0,r+1).forEach(function(t){e.emitEvent("offlineQueuePop",t.query)})),e.queueMaxSize>0&&e.offlineQueue.length>e.queueMaxSize&&e.offlineQueue.splice(0,e.offlineQueue.length-e.queueMaxSize).forEach(function(t){e.emitEvent("offlineQueuePop",t.query)})}function d(e,t){var r=this;(void 0!==r.jwtToken||t)&&r.network.once(e.requestId,function(n){var i=null;"logout"!==e.action&&n.error&&"Token expired"===n.error.message&&(r.jwtToken=void 0,r.emitEvent("tokenExpired",e,t)),n.error&&(i=new Error(n.error.message),Object.assign(i,n.error),i.status=n.status,r.emitEvent("queryError",i,e,t)),t&&t(i,n)}),this.network.send(e)}function h(){var e,t=this,r={},n=function(){t.offlineQueue.length>0?(d.call(t,t.offlineQueue[0].query,t.offlineQueue[0].cb),t.emitEvent("offlineQueuePop",t.offlineQueue.shift()),setTimeout(function(){n()},Math.max(0,t.replayInterval))):t.queuing=!1};if(t.offlineQueueLoader){if("function"!=typeof t.offlineQueueLoader)throw new Error("Invalid value for offlineQueueLoader property. Expected: function. Got: "+typeof t.offlineQueueLoader);if(e=t.offlineQueueLoader(),!Array.isArray(e))throw new Error("Invalid value returned by the offlineQueueLoader function. Expected: array. Got: "+typeof e);t.offlineQueue=e.concat(t.offlineQueue).filter(function(e){if(!e.query||void 0===e.query.requestId||!e.query.action||!e.query.controller)throw new Error("Invalid offline queue request. One or more missing properties: requestId, action, controller.");return!r.hasOwnProperty(e.query.requestId)&&(r[e.query.requestId]=!0)})}n()}function p(){var e=this;Object.keys(e.subscriptions).forEach(function(t){Object.keys(e.subscriptions[t]).forEach(function(r){var n=e.subscriptions[t][r];n.renew(n.callback)})})}function y(e,t){t&&t(new Error("Unable to execute request: not connected to a Kuzzle server.\nDiscarded request: "+JSON.stringify(e)))}a.prototype=Object.create(i.prototype),a.prototype.constructor=a,a.prototype.emit=function(e){var t=Date.now(),r=this.protectedEvents[e];if(r){if(r.lastEmitted&&r.lastEmitted>t-r.timeout)return!1;r.lastEmitted=t}i.prototype.emit.apply(this,arguments)},a.prototype.emitEvent=a.prototype.emit,a.prototype.connect=function(){var e=this;return e.network&&e.disconnect(),e.network=c(e.host,e.port,e.sslConnection),-1===["initializing","ready","disconnected","error","offline"].indexOf(this.state)?(e.connectCB&&e.connectCB(null,e),e):(e.state="connecting",e.network.connect(e.autoReconnect,e.reconnectionDelay),e.network.onConnect(function(){e.state="connected",p.call(e),h.call(e),e.emitEvent("connected"),e.connectCB&&e.connectCB(null,e)}),e.network.on("discarded",function(t){e.emitEvent("discarded",t)}),e.network.onConnectError(function(t){var r=new Error('Unable to connect to kuzzle proxy server at "'+e.host+":"+e.port+'"');r.internal=t,e.state="error",e.emitEvent("networkError",r),function(){var e=this;Object.keys(e.subscriptions).forEach(function(t){Object.keys(e.subscriptions[t]).forEach(function(r){var n=e.subscriptions[t][r];n.subscribing=!1})})}.call(e),e.connectCB&&e.connectCB(r)}),e.network.onDisconnect(function(){e.state="offline",e.autoReconnect||e.disconnect(),e.autoQueue&&(e.queuing=!0),e.emitEvent("disconnected")}),e.network.onReconnect(function(){var t=function(){e.autoResubscribe&&p.call(e),e.autoReplay&&(f.call(e),h.call(e)),e.emitEvent("reconnected")};e.state="connected",e.jwtToken?e.checkToken(e.jwtToken,function(r,n){!r&&n.valid||(e.jwtToken=void 0,e.emitEvent("tokenExpired")),t()}):t()}),this)},a.prototype.setJwtToken=function(e){if("string"==typeof e)this.jwtToken=e;else{if("object"!=typeof e)return this.emitEvent("loginAttempt",{success:!1,error:"Invalid token argument: "+e}),this;if(!e.result||!e.result.jwt||"string"!=typeof e.result.jwt)return this.emitEvent("loginAttempt",{success:!1,error:"Cannot find a valid JWT token in the following object: "+JSON.stringify(e)}),this;this.jwtToken=e.result.jwt}return p.call(this),this.emitEvent("loginAttempt",{success:!0}),this},a.prototype.unsetJwtToken=function(){return this.jwtToken=void 0,function(){var e=this;Object.keys(e.subscriptions).forEach(function(t){Object.keys(e.subscriptions[t]).forEach(function(r){var n=e.subscriptions[t][r];n.unsubscribe()})})}.call(this),this},a.prototype.getJwtToken=function(){return this.jwtToken},a.prototype.login=function(e){var t=this,r={body:{},strategy:e},n=null;if(!e||"string"!=typeof e)throw new Error("Kuzzle.login: strategy required");arguments[1]&&("object"==typeof arguments[1]?r.body=arguments[1]:"number"==typeof arguments[1]||"string"==typeof arguments[1]?r.expiresIn=arguments[1]:"function"==typeof arguments[1]&&(n=arguments[1])),arguments[2]&&("number"==typeof arguments[2]||"string"==typeof arguments[2]?r.expiresIn=arguments[2]:"function"==typeof arguments[2]&&(n=arguments[2])),arguments[3]&&"function"==typeof arguments[3]&&(n=arguments[3]),this.query({controller:"auth",action:"login"},r,{queuable:!1},function(e,r){e?(n&&n(e),t.emitEvent("loginAttempt",{success:!1,error:e.message})):(r.result.jwt&&t.setJwtToken(r.result.jwt),n&&n(null,r.result))})},a.prototype.createMyCredentials=function(e,t,r,n){return n||"function"!=typeof r||(n=r,r=null),this.query({controller:"auth",action:"createMyCredentials"},{strategy:e,body:t},r,function(e,t){e?n&&n(e):n&&n(null,t.result._source)}),this},a.prototype.deleteMyCredentials=function(e,t,r){return r||"function"!=typeof t||(r=t,t=null),this.query({controller:"auth",action:"deleteMyCredentials"},{strategy:e},t,"function"!=typeof r?null:function(e,t){e?r&&r(e):r&&r(null,t.result)}),this},a.prototype.getMyCredentials=function(e,t,r){r||"function"!=typeof t||(r=t,t=null),this.query({controller:"auth",action:"getMyCredentials"},{strategy:e},t,"function"!=typeof r?null:function(e,t){e?r&&r(e):r&&r(null,t.result)})},a.prototype.updateMyCredentials=function(e,t,r,n){return n||"function"!=typeof r||(n=r,r=null),this.query({controller:"auth",action:"updateMyCredentials"},{strategy:e,body:t},r,"function"!=typeof n?null:function(e,t){e?n&&n(e):n&&n(null,t.result)}),this},a.prototype.validateMyCredentials=function(e,t,r,n){n||"function"!=typeof r||(n=r,r=null),this.query({controller:"auth",action:"validateMyCredentials"},{strategy:e,body:t},r,"function"!=typeof n?null:function(e,t){e?n&&n(e):n&&n(null,t.result)})},a.prototype.createIndex=function(e,t,r){if(!e){if(!this.defaultIndex)throw new Error("Kuzzle.createIndex: index required");e=this.defaultIndex}return r||"function"!=typeof t||(r=t,t=null),this.query({controller:"index",action:"create",index:e},{},t,"function"!=typeof r?null:function(e,t){r(e,e?void 0:t.result)}),this},a.prototype.logout=function(e){var t=this,r={action:"logout",controller:"auth",requestId:n(),body:{}};return this.query({controller:"auth",action:"logout"},r,{queuable:!1},"function"!=typeof e?null:function(r){e(r,t)}),t.unsetJwtToken(),t},a.prototype.checkToken=function(e,t){var r={body:{token:e}};this.callbackRequired("Kuzzle.checkToken",t),this.query({controller:"auth",action:"checkToken"},r,{queuable:!1},function(e,r){t(e,e?void 0:r.result)})},a.prototype.whoAmI=function(e){var t=this;t.callbackRequired("Kuzzle.whoAmI",e),t.query({controller:"auth",action:"getCurrentUser"},{},{},function(r,n){e(r,r?void 0:new l(t.security,n.result._id,n.result._source,n.result._meta))})},a.prototype.getMyRights=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.getMyRights",t),this.query({controller:"auth",action:"getMyRights"},{},e,function(e,r){t(e,e?void 0:r.result.hits)})},a.prototype.updateSelf=function(e,t,r){var n={};return r||"function"!=typeof t||(r=t,t=null),n.body=e,this.query({controller:"auth",action:"updateSelf"},n,t,r&&function(e,t){r(e,e?void 0:t.result)}),this},a.prototype.addListener=function(e,t){if(this.isValid(),-1===this.eventActions.indexOf(e))throw new Error("["+e+"] is not a known event. Known events: "+this.eventActions.toString());return i.prototype.addListener.call(this,e,t)},a.prototype.getAllStatistics=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.getAllStatistics",t),this.query({controller:"server",action:"getAllStats"},{},e,function(e,r){t(e,e?void 0:r.result.hits)})},a.prototype.getStatistics=function(e,t,r){var n,i;r||(1===arguments.length?(r=arguments[0],t=null,e=null):(r=arguments[1],"object"==typeof arguments[0]?(t=arguments[0],e=null):(e=arguments[0],t=null))),n=function(t,n){if(t)return r(t);r(null,e?n.result.hits:[n.result])},this.callbackRequired("Kuzzle.getStatistics",r),i=e?{body:{startTime:e}}:{},this.query({controller:"server",action:e?"getStats":"getLastStats"},i,t,n)},a.prototype.collection=function(e,t){if(this.isValid(),!t){if(!this.defaultIndex)throw new Error("Unable to create a new data collection object: no index specified");t=this.defaultIndex}if("string"!=typeof t||"string"!=typeof e)throw new Error("Invalid index or collection argument: string expected");return this.collections[t]||(this.collections[t]={}),this.collections[t][e]||(this.collections[t][e]=new o(this,e,t)),this.collections[t][e]},a.prototype.flushQueue=function(){return this.offlineQueue=[],this},a.prototype.listCollections=function(){var e,t,r,n;if(Array.prototype.slice.call(arguments).forEach(function(n){switch(typeof n){case"string":e=n;break;case"object":t=n;break;case"function":r=n}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.listCollections: index required");e=this.defaultIndex}this.callbackRequired("Kuzzle.listCollections",r),n={type:t&&t.type||"all"},this.query({index:e,controller:"collection",action:"list"},n,t,function(e,t){r(e,e?void 0:t.result.collections)})},a.prototype.listIndexes=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.listIndexes",t),this.query({controller:"index",action:"list"},{},e,function(e,r){t(e,e?void 0:r.result.indexes)})},a.prototype.disconnect=function(){var e;for(e in this.state="disconnected",this.network.close(),this.network=null,this.collections)this.collections.hasOwnProperty(e)&&delete this.collections[e]},a.prototype.getServerInfo=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.getServerInfo",t),this.query({controller:"server",action:"info"},{},e,function(e,r){t(e,e?void 0:r.result.serverInfo)})},a.prototype.refreshIndex=function(){var e,t,r;if(Array.prototype.slice.call(arguments).forEach(function(n){switch(typeof n){case"string":e=n;break;case"object":t=n;break;case"function":r=n}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.refreshIndex: index required");e=this.defaultIndex}return this.query({index:e,controller:"index",action:"refresh"},{},t,r),this},a.prototype.getAutoRefresh=function(){var e,t,r;if(Array.prototype.slice.call(arguments).forEach(function(n){switch(typeof n){case"string":e=n;break;case"object":t=n;break;case"function":r=n}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.getAutoRefresh: index required");e=this.defaultIndex}this.callbackRequired("Kuzzle.getAutoRefresh",r),this.query({index:e,controller:"index",action:"getAutoRefresh"},{},t,r)},a.prototype.setAutoRefresh=function(){var e,t,r,n;if(Array.prototype.slice.call(arguments).forEach(function(i){switch(typeof i){case"string":e=i;break;case"boolean":t=i;break;case"object":r=i;break;case"function":n=i}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.setAutoRefresh: index required");e=this.defaultIndex}if(void 0===t)throw new Error("Kuzzle.setAutoRefresh: autoRefresh value is required");return this.query({index:e,controller:"index",action:"setAutoRefresh"},{body:{autoRefresh:t}},r,n),this},a.prototype.now=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.now",t),this.query({controller:"server",action:"now"},{},e,function(e,r){t(e,e?void 0:r.result.now)})},a.prototype.query=function(e,t,r,i){var o,s={action:e.action,controller:e.controller,volatile:this.volatile};if(this.isValid(),i||"function"!=typeof r||(i=r,r=null),r){if(!1===r.queuable&&"offline"===this.state)return this;r.refresh&&(s.refresh=r.refresh),void 0!==r.from&&null!==r.from&&(s.from=r.from),r.size&&(s.size=r.size),r.scroll&&(s.scroll=r.scroll),r.scrollId&&(s.scrollId=r.scrollId),r.volatile&&Object.keys(r.volatile).forEach(function(e){s.volatile[e]=r.volatile[e]})}if(!t||"object"!=typeof t||Array.isArray(t))throw new Error("Invalid query parameter: "+t);for(o in t.volatile&&Object.keys(t.volatile).forEach(function(e){s.volatile[e]=t.volatile[e]}),t)"volatile"!==o&&t.hasOwnProperty(o)&&(s[o]=t[o]);return s=this.addHeaders(s,this.headers),void 0===this.jwtToken||"auth"===s.controller&&"checkToken"===s.action||(s.jwt=this.jwtToken),e.collection&&(s.collection=e.collection),e.index&&(s.index=e.index),s.requestId||(s.requestId=n()),s.volatile.sdkVersion=this.sdkVersion,s.volatile.sdkInstanceId=this.id,"connected"===this.state||r&&!1===r.queuable?"connected"===this.state?d.call(this,s,i):y(s,i):this.queuing||r&&!0===r.queuable||-1!==["initializing","connecting"].indexOf(this.state)?(f.call(this,s,i),!this.queueFilter||this.queueFilter(s)?(this.offlineQueue.push({ts:Date.now(),query:s,cb:i}),this.emitEvent("offlineQueuePush",{query:s,cb:i})):y(s,i)):y(s,i),this},a.prototype.replayQueue=function(){return"offline"===this.state||this.autoReplay||(f.call(this),h.call(this)),this},a.prototype.setDefaultIndex=function(e){if("string"!=typeof e)throw new Error("Invalid default index: ["+e+"] (an index name is expected)");if(0===e.length)throw new Error("Cannot set an empty index as the default index");return this.defaultIndex=e,this},a.prototype.setHeaders=function(e,t){var r=this;if("object"!=typeof e||Array.isArray(e))throw new Error("Expected a content object, received a "+typeof e);return t?r.headers=e:Object.keys(e).forEach(function(t){r.headers[t]=e[t]}),r},a.prototype.startQueuing=function(){return"offline"!==this.state||this.autoQueue||(this.queuing=!0),this},a.prototype.stopQueuing=function(){return"offline"!==this.state||this.autoQueue||(this.queuing=!1),this},e.exports=a},function(e,t){var r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(r){var n=new Uint8Array(16);e.exports=function(){return r(n),n}}else{var i=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),i[t]=e>>>((3&t)<<3)&255;return i}}},function(e,t){for(var r=[],n=0;n<256;++n)r[n]=(n+256).toString(16).substr(1);e.exports=function(e,t){var n=t||0,i=r;return[i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]]].join("")}},function(e,t,r){"use strict";var n,i="object"==typeof Reflect?Reflect:null,o=i&&"function"==typeof i.apply?i.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};n=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function u(){u.init.call(this)}e.exports=u,u.EventEmitter=u,u.prototype._events=void 0,u.prototype._eventsCount=0,u.prototype._maxListeners=void 0;var l=10;function c(e){return void 0===e._maxListeners?u.defaultMaxListeners:e._maxListeners}function a(e,t,r,n){var i,o,s,u;if("function"!=typeof r)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r);if(void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),o=e._events),s=o[t]),void 0===s)s=o[t]=r,++e._eventsCount;else if("function"==typeof s?s=o[t]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),(i=c(e))>0&&s.length>i&&!s.warned){s.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=s.length,u=l,console&&console.warn&&console.warn(u)}return e}function f(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,o(this.listener,this.target,e))}.bind(n);return i.listener=r,n.wrapFn=i,i}function d(e,t,r){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(i):p(i,i.length)}function h(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function p(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}Object.defineProperty(u,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),u.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},u.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},u.prototype.getMaxListeners=function(){return c(this)},u.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var n="error"===e,i=this._events;if(void 0!==i)n=n&&void 0===i.error;else if(!n)return!1;if(n){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var u=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw u.context=s,u}var l=i[e];if(void 0===l)return!1;if("function"==typeof l)o(l,this,t);else{var c=l.length,a=p(l,c);for(r=0;r<c;++r)o(a[r],this,t)}return!0},u.prototype.addListener=function(e,t){return a(this,e,t,!1)},u.prototype.on=u.prototype.addListener,u.prototype.prependListener=function(e,t){return a(this,e,t,!0)},u.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,f(this,e,t)),this},u.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,f(this,e,t)),this},u.prototype.removeListener=function(e,t){var r,n,i,o,s;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(n=this._events))return this;if(void 0===(r=n[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){s=r[o].listener,i=o;break}if(i<0)return this;0===i?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,i),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,s||t)}return this},u.prototype.off=u.prototype.removeListener,u.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var i,o=Object.keys(r);for(n=0;n<o.length;++n)"removeListener"!==(i=o[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},u.prototype.listeners=function(e){return d(this,e,!0)},u.prototype.rawListeners=function(e){return d(this,e,!1)},u.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},u.prototype.listenerCount=h,u.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},function(e,t,r){var n=r(11),i=r(3),o=r(12),s=r(13),u=r(14);function l(e,t,r){if(!r||!t)throw new Error("The Collection object constructor needs an index and a collection arguments");return Object.defineProperties(this,{collection:{value:t,enumerable:!0},index:{value:r,enumerable:!0},kuzzle:{value:e,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0}}),Object.defineProperty(this,"buildQueryArgs",{value:function(e,t){return{controller:e,action:t,collection:this.collection,index:this.index}}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1===["publishMessage","setHeaders","subscribe"].indexOf(e)}}):this}l.prototype.count=function(e,t,r){var n;r||"function"!=typeof t||(r=t,t=null),this.kuzzle.callbackRequired("Collection.count",r),n=this.kuzzle.addHeaders({body:e},this.headers),this.kuzzle.query(this.buildQueryArgs("document","count"),n,t,function(e,t){r(e,e?void 0:t.result.count)})},l.prototype.create=function(){var e,t={},r=null,n=null,i=null,o=this;for(e=0;e<arguments.length;e++)if("function"==typeof arguments[e]){if(e<arguments.length-1)throw new Error("Invalid argument: "+arguments[e+1]);i=arguments[e]}else{if("object"!=typeof arguments[e]||Array.isArray(arguments[e]))throw new Error("Invalid argument: "+arguments[e]);if(null===r)r=arguments[e];else{if(null!==n)throw new Error("Too many objects arguments");n=arguments[e]}}return null===r||null===n&&"boolean"==typeof r.queuable?(n=r,t={}):t={body:r},t=this.kuzzle.addHeaders(t,this.headers),this.kuzzle.query(this.buildQueryArgs("collection","create"),t,n,function(e){i(e,e?void 0:o)}),this},l.prototype.createDocument=function(e,t,r,n){var o=this,s={},u="create";if(e&&"string"!=typeof e&&(n=r,r=t,t=e,e=null),n||"function"!=typeof r||(n=r,r=null),t instanceof i?s=t.serialize():s.body=t,r&&r.ifExist)if("replace"===r.ifExist)u="createOrReplace";else if("error"!==r.ifExist)throw new Error('Invalid value for the "ifExist" option: '+r.ifExist);return e&&(s._id=e),s=o.kuzzle.addHeaders(s,o.headers),o.kuzzle.query(this.buildQueryArgs("document",u),s,r,n&&function(e,t){var r;if(e)return n(e);(r=new i(o,t.result._id,t.result._source,t.result._meta)).version=t.result._version,n(null,r)}),this},l.prototype.deleteDocument=function(e,t,r){var n,i={};return"string"==typeof e?(i._id=e,n="delete"):(i.body={query:e},n="deleteByQuery"),r||"function"!=typeof t||(r=t,t=null),i=this.kuzzle.addHeaders(i,this.headers),this.kuzzle.query(this.buildQueryArgs("document",n),i,t,r&&function(e,t){e?r(e):r(null,"delete"===n?[t.result._id]:t.result.ids)}),this},l.prototype.deleteSpecifications=function(e,t){var r={index:this.index,collection:this.collection};return t||"function"!=typeof e||(t=e,e=null),r=this.kuzzle.addHeaders(r,this.headers),this.kuzzle.query(this.buildQueryArgs("collection","deleteSpecifications"),r,e,function(e,r){t(e,e?void 0:r.result)}),this},l.prototype.documentExists=function(e,t,r){var n={_id:e};r||"function"!=typeof t||(r=t,t=null),this.kuzzle.callbackRequired("Collection.documentExists",r),this.kuzzle.query(this.buildQueryArgs("document","exists"),n,t,function(e,t){r(e,e?void 0:t.result)})},l.prototype.fetchDocument=function(e,t,r){var n={_id:e},o=this;r||"function"!=typeof t||(r=t,t=null),o.kuzzle.callbackRequired("Collection.fetch",r),n=o.kuzzle.addHeaders(n,this.headers),o.kuzzle.query(this.buildQueryArgs("document","get"),n,t,function(e,t){var n;if(e)return r(e);(n=new i(o,t.result._id,t.result._source,t.result._meta)).version=t.result._version,r(null,n)})},l.prototype.getMapping=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.kuzzle.callbackRequired("Collection.getMapping",t),new o(this).refresh(e,t)},l.prototype.mCreateDocument=function(e,t,r){var n={body:{}};return r||"function"!=typeof t||(r=t,t=null),Array.isArray(e)?(this.kuzzle.callbackRequired("Collection.mCreate",r),n.body.documents=e.map(function(e){return e instanceof i?e.serialize():e}),n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query(this.buildQueryArgs("document","mCreate"),n,t,r&&function(e,t){r(e,e?void 0:t.result)}),this):r(new Error("Collection.mCreateDocument: documents parameter format is invalid (should be an array of documents)"))},l.prototype.mCreateOrReplaceDocument=function(e,t,r){var n={body:{}};return r||"function"!=typeof t||(r=t,t=null),Array.isArray(e)?(this.kuzzle.callbackRequired("Collection.mCreateOrReplace",r),n.body.documents=e.map(function(e){return e instanceof i?e.serialize():e}),n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query(this.buildQueryArgs("document","mCreateOrReplace"),n,t,r&&function(e,t){r(e,e?void 0:t.result)}),this):r(new Error("Collection.mCreateOrReplaceDocument: documents parameter format is invalid (should be an array of documents)"))},l.prototype.mDeleteDocument=function(e,t,r){var n={body:{ids:e}};return r||"function"!=typeof t||(r=t,t=null),Array.isArray(e)?(this.kuzzle.callbackRequired("Collection.mDelete",r),n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query(this.buildQueryArgs("document","mDelete"),n,t,r&&function(e,t){r(e,e?void 0:t.result)}),this):r(new Error("Collection.mDeleteDocument: documentIds parameter format is invalid (should be an array of IDs)"))},l.prototype.mGetDocument=function(e,t,r){var n={body:{ids:e}};if(r||"function"!=typeof t||(r=t,t=null),!Array.isArray(e))return r(new Error("Collection.mGetDocument: documentIds parameter format is invalid (should be an array of IDs)"));this.kuzzle.callbackRequired("Collection.mGet",r),n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query(this.buildQueryArgs("document","mGet"),n,t,r&&function(e,t){r(e,e?void 0:t.result)})},l.prototype.mReplaceDocument=function(e,t,r){var n={body:{}};return r||"function"!=typeof t||(r=t,t=null),Array.isArray(e)?(this.kuzzle.callbackRequired("Collection.mReplace",r),n.body.documents=e.map(function(e){return e instanceof i?e.serialize():e}),n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query(this.buildQueryArgs("document","mReplace"),n,t,r&&function(e,t){r(e,e?void 0:t.result)}),this):r(new Error("Collection.mReplaceDocument: documents parameter format is invalid (should be an array of documents)"))},l.prototype.mUpdateDocument=function(e,t,r){var n={body:{}};return r||"function"!=typeof t||(r=t,t=null),Array.isArray(e)?(this.kuzzle.callbackRequired("Collection.mUpdate",r),n.body.documents=e.map(function(e){return e instanceof i?e.serialize():e}),n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query(this.buildQueryArgs("document","mUpdate"),n,t,r&&function(e,t){r(e,e?void 0:t.result)}),this):r(new Error("Collection.mUpdateDocument: documents parameter format is invalid (should be an array of documents)"))},l.prototype.getSpecifications=function(e,t){var r={index:this.index,collection:this.collection};t||"function"!=typeof e||(t=e,e=null),this.kuzzle.callbackRequired("Collection.getSpecifications",t),r=this.kuzzle.addHeaders(r,this.headers),this.kuzzle.query(this.buildQueryArgs("collection","getSpecifications"),r,e,function(e,r){t(e,e?void 0:r.result)})},l.prototype.publishMessage=function(e,t,r){var n={};return e instanceof i?n=e.serialize():n.body=e,n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query(this.buildQueryArgs("realtime","publish"),n,t,r),this},l.prototype.replaceDocument=function(e,t,r,n){var o=this,s={_id:e,body:t};return n||"function"!=typeof r||(n=r,r=null),s=o.kuzzle.addHeaders(s,this.headers),o.kuzzle.query(this.buildQueryArgs("document","createOrReplace"),s,r,n&&function(e,t){var r;if(e)return n(e);(r=new i(o,t.result._id,t.result._source,t.result._meta)).version=t.result._version,n(null,r)}),this},l.prototype.search=function(e,t,r){var o,s=this;r||"function"!=typeof t||(r=t,t={}),s.kuzzle.callbackRequired("Collection.search",r),o=s.kuzzle.addHeaders({body:e},this.headers),s.kuzzle.query(this.buildQueryArgs("document","search"),o,t,function(o,u){var l=[];if(o)return r(o);u.result.hits.forEach(function(e){var t=new i(s,e._id,e._source,e._meta);t.version=e._version,l.push(t)}),u.result._scroll_id&&(t.scrollId=u.result._scroll_id),r(null,new n(s,u.result.total,l,u.result.aggregations?u.result.aggregations:{},t,e,t.previous||null))})},l.prototype.scroll=function(e,t,r,o){var s={},u=this;if(!e)throw new Error("Collection.scroll: scrollId is required");return o||(o=r,r=null),o||"function"!=typeof t||(o=t,t={}),this.kuzzle.callbackRequired("Collection.scroll",o),s.scrollId=e,t&&t.scroll&&(s.scroll=t.scroll),this.kuzzle.query({controller:"document",action:"scroll"},s,t,function(e,s){var l=[];if(e)return o(e);s.result.hits.forEach(function(e){var t=new i(u,e._id,e._source,e._meta);t.version=e._version,l.push(t)}),s.result._scroll_id&&(t.scrollId=s.result._scroll_id),o(null,new n(u,s.result.total,l,{},t,r,t.previous||null))}),this},l.prototype.scrollSpecifications=function(e,t,r){var n={scrollId:e};if(!e)throw new Error("Collection.scrollSpecifications: scrollId is required");r||"function"!=typeof t||(r=t,t={}),this.kuzzle.callbackRequired("Collection.scrollSpecifications",r),t&&t.scroll&&(n.scroll=t.scroll),this.kuzzle.query({controller:"collection",action:"scrollSpecifications"},this.kuzzle.addHeaders(n,this.headers),t,function(e,t){r(e,e?void 0:t.result)})},l.prototype.searchSpecifications=function(e,t,r){var n={body:{query:e}};r||"function"!=typeof t||(r=t,t={}),this.kuzzle.callbackRequired("Collection.searchSpecifications",r),n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query({controller:"collection",action:"searchSpecifications"},n,t,function(e,t){r(e,e?void 0:t.result)})},l.prototype.subscribe=function(e,t,r){var n;return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.callbackRequired("Collection.subscribe",r),n=new u,new s(this,t).renew(e,r,n.done.bind(n)),n},l.prototype.truncate=function(e,t){var r={};return t||"function"!=typeof e||(t=e,e=null),r=this.kuzzle.addHeaders(r,this.headers),this.kuzzle.query(this.buildQueryArgs("collection","truncate"),r,e,t),this},l.prototype.updateDocument=function(e,t,r,n){var o={_id:e,body:t},s=this;return n||"function"!=typeof r||(n=r,r=null),r&&r.retryOnConflict&&(o.retryOnConflict=r.retryOnConflict),o=s.kuzzle.addHeaders(o,this.headers),s.kuzzle.query(this.buildQueryArgs("document","update"),o,r,n&&function(e,t){if(e)return n(e);new i(s,t.result._id).refresh(n)}),s},l.prototype.updateSpecifications=function(e,t,r){var n={},i={body:{}};return n[this.collection]=e,i.body[this.index]=n,r||"function"!=typeof t||(r=t,t=null),i=this.kuzzle.addHeaders(i,this.headers),this.kuzzle.query(this.buildQueryArgs("collection","updateSpecifications"),i,t,r&&function(e,t){r(e,e?void 0:t.result)}),this},l.prototype.validateSpecifications=function(e,t,r){var n={},i={body:{}};n[this.collection]=e,i.body[this.index]=n,r||"function"!=typeof t||(r=t,t=null),this.kuzzle.callbackRequired("Collection.validateSpecifications",r),i=this.kuzzle.addHeaders(i,this.headers),this.kuzzle.query(this.buildQueryArgs("collection","validateSpecifications"),i,t,function(e,t){r(e,e?void 0:t.result.valid)})},l.prototype.document=function(e,t){return new i(this,e,t)},l.prototype.room=function(e){return new s(this,e)},l.prototype.collectionMapping=function(e){return new o(this,e)},l.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=l},function(e,t){function r(e,t,n,i,o,s,u){return Object.defineProperties(this,{collection:{value:e,enumerable:!0},total:{value:t,enumerable:!0},documents:{value:n,enumerable:!0},aggregations:{value:i||{},enumerable:!0},options:{value:o||{},enumerable:!0},filters:{value:s||{},enumerable:!0},fetchedDocument:{value:u instanceof r?n.length+u.fetchedDocument:n.length,enumerable:!0,writable:!0}}),this.collection.kuzzle.bluebird?this.collection.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["fetchNext"].indexOf(e)}}):this}r.prototype.fetchNext=function(e){var t,r=Object.assign({},this.options),n=this;return r.previous=this,r.scrollId?this.fetchedDocument>=this.getTotal()?void e(null,null):(void 0!==r.from&&delete r.from,r.size&&delete r.size,void this.collection.scroll(r.scrollId,r,this.filters||{},e)):r.size&&this.filters.sort?this.fetchedDocument>=this.getTotal()?void e(null,null):(r.from&&delete r.from,(t=Object.assign(this.filters,{search_after:[]})).sort.forEach(function(e){t.search_after.push(n.documents[n.documents.length-1].content[Object.keys(e)[0]])}),void this.collection.search(t,r,e)):void 0!==r.from&&void 0!==r.size?(t=Object.assign({},this.filters),r.from+=r.size,r.from>=this.getTotal()?void e(null,null):void this.collection.search(t,r,e)):void e(new Error("Unable to retrieve next results from search: missing scrollId or from/size params"))},r.prototype.getDocuments=function(){return this.documents},r.prototype.getTotal=function(){return this.total},r.prototype.getAggregations=function(){return this.aggregations},r.prototype.getOptions=function(){return this.options},r.prototype.getFilters=function(){return this.filters},r.prototype.getCollection=function(){return this.collection},r.prototype.getFetchedDocument=function(){return this.fetchedDocument},e.exports=r},function(e,t){function r(e,t){return Object.defineProperties(this,{collection:{value:e,enumerable:!0},kuzzle:{value:e.kuzzle,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0},mapping:{value:t||{},enumerable:!0,writable:!0}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1===["set","setHeaders"].indexOf(e)}}):this}r.prototype.apply=function(e,t){var r=this,n=this.kuzzle.addHeaders({body:{properties:this.mapping}},this.headers);return t||"function"!=typeof e||(t=e,e=null),r.kuzzle.query(this.collection.buildQueryArgs("collection","updateMapping"),n,e,function(n){if(n)return t&&t(n);r.refresh(e,t)}),this},r.prototype.refresh=function(e,t){var r=this,n=this.kuzzle.addHeaders({},this.headers);return t||"function"!=typeof e||(t=e,e=null),this.kuzzle.query(this.collection.buildQueryArgs("collection","getMapping"),n,e,function(e,n){return e?!!t&&t(e):n.result[r.collection.index]?n.result[r.collection.index].mappings[r.collection.collection]?(r.mapping=n.result[r.collection.index].mappings[r.collection.collection].properties,void 0===r.mapping&&(r.mapping={}),void(t&&t(null,r))):t&&t(new Error("No mapping found for collection "+r.collection.collection)):t&&t(new Error("No mapping found for index "+r.collection.index))}),this},r.prototype.set=function(e,t){return this.mapping[e]=t,this},r.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=r},function(e,t,r){var n=r(1),i=r(3);function o(e,t){return Object.defineProperties(this,{callback:{value:null,writable:!0},channel:{value:null,writable:!0},id:{value:n()},lastRenewal:{value:null,writable:!0},notifier:{value:null,writable:!0},onDoneCB:{value:null,writable:!0},queue:{value:[],writable:!0},renewalDelay:{value:500},scope:{value:t&&t.scope?t.scope:"all"},state:{value:t&&t.state?t.state:"done"},subscribing:{value:!1,writable:!0},users:{value:t&&t.users?t.users:"none"},collection:{value:e,enumerable:!0},kuzzle:{value:e.kuzzle,enumerable:!0},filters:{value:null,enumerable:!0,writable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0},volatile:{value:t&&t.volatile?t.volatile:{},enumerable:!0,writable:!0},roomId:{value:null,enumerable:!0,writable:!0},subscribeToSelf:{value:!t||"boolean"!=typeof t.subscribeToSelf||t.subscribeToSelf,enumerable:!0,writable:!0}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["count"].indexOf(e)}}):this}function s(){return"connected"===this.kuzzle.state&&!this.subscribing}o.prototype.count=function(e){var t;if(this.kuzzle.callbackRequired("Room.count",e),t=this.kuzzle.addHeaders({body:{roomId:this.roomId}},this.headers),s.call(this)){if(!this.roomId)throw new Error("Room.count: cannot count subscriptions on an inactive room");this.kuzzle.query(this.collection.buildQueryArgs("realtime","count"),t,function(t,r){e(t,r&&r.result.count)})}else this.queue.push({action:"count",args:[e]})},o.prototype.renew=function(e,t,r){var n=this,o=Date.now(),s={scope:n.scope,state:n.state,users:n.users};return"function"==typeof e&&(r=t,t=e,e=null),r||(r=n.onDoneCB),n.kuzzle.callbackRequired("Room.renew",t),n.lastRenewal&&o-n.lastRenewal<=n.renewalDelay?r&&r(new Error("Subscription already renewed less than "+n.renewalDelay+"ms ago")):(e&&(n.filters=e),"connected"!==n.kuzzle.state?(n.callback=t,n.onDoneCB=r,void(n.kuzzle.subscriptions.pending[n.id]=n)):void(n.subscribing?n.queue.push({action:"renew",args:[e,t,r]}):(n.unsubscribe(),n.roomId=null,n.subscribing=!0,n.callback=t,n.onDoneCB=r,n.kuzzle.subscriptions.pending[n.id]=n,s.body=n.filters,s=n.kuzzle.addHeaders(s,n.headers),n.kuzzle.query(n.collection.buildQueryArgs("realtime","subscribe"),s,{volatile:n.volatile},function(e,t){if(delete n.kuzzle.subscriptions.pending[n.id],n.subscribing=!1,e)return n.queue=[],r&&r(new Error("Error during Kuzzle subscription: "+e.message));n.lastRenewal=o,n.roomId=t.result.roomId,n.channel=t.result.channel,n.kuzzle.subscriptions[n.roomId]||(n.kuzzle.subscriptions[n.roomId]={}),n.kuzzle.subscriptions[n.roomId][n.id]=n,n.notifier=function(e){var t=Object.assign({},e);if("TokenExpired"===e.type)return this.kuzzle.jwtToken=void 0,this.kuzzle.emitEvent("tokenExpired");"document"===t.type&&(t.document=new i(this.collection,t.result._id,t.result._source,t.result._meta),delete t.result);!this.subscribeToSelf&&t.volatile&&t.volatile.sdkInstanceId===this.kuzzle.id||this.callback(null,t)}.bind(n),n.kuzzle.network.on(n.channel,n.notifier),function(){var e;for(;this.queue.length>0;)this[(e=this.queue.shift()).action].apply(this,e.args)}.call(n),r&&r(null,n)}))))},o.prototype.unsubscribe=function(){var e,t=this,r=t.roomId;return s.call(this)?(r&&(t.kuzzle.network.off(t.channel,this.notifier),1===Object.keys(t.kuzzle.subscriptions[r]).length?(delete t.kuzzle.subscriptions[r],0===Object.keys(t.kuzzle.subscriptions.pending).length?t.kuzzle.query(t.collection.buildQueryArgs("realtime","unsubscribe"),{body:{roomId:r}}):e=setInterval(function(){0===Object.keys(t.kuzzle.subscriptions.pending).length&&(t.kuzzle.subscriptions[r]||t.kuzzle.query(t.collection.buildQueryArgs("realtime","unsubscribe"),{body:{roomId:r}}),clearInterval(e))},100)):delete t.kuzzle.subscriptions[r][t.id],t.roomId=null),t):(t.queue.push({action:"unsubscribe",args:[]}),t)},o.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=o},function(e,t){function r(){this.cbs=[],this.error=null,this.room=null}r.prototype.onDone=function(e){return this.error||this.room?e(this.error,this.room):this.cbs.push(e),this},r.prototype.done=function(e,t){this.error=e,this.room=t,this.cbs.forEach(function(r){r(e,t)})},e.exports=r},function(e,t,r){var n=r(16),i=r(17),o=r(4);function s(e){return Object.defineProperty(this,"kuzzle",{value:e}),Object.defineProperty(this,"buildQueryArgs",{value:function(e){return{controller:"security",action:e}}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1===["role","profile","user","isActionAllowed"].indexOf(e)}}):this}s.prototype.fetchRole=function(e,t,r){var i,o=this;if(!e)throw new Error("Id parameter is mandatory for fetchRole function");r||"function"!=typeof t||(r=t,t=null),i={_id:e},o.kuzzle.callbackRequired("Security.fetchRole",r),o.kuzzle.query(this.buildQueryArgs("getRole"),i,t,function(e,t){r(e,e?void 0:new n(o,t.result._id,t.result._source,t.result._meta))})},s.prototype.searchRoles=function(e,t,r){var i=this;r||"function"!=typeof t||(r=t,t=null),i.kuzzle.callbackRequired("Security.searchRoles",r),i.kuzzle.query(this.buildQueryArgs("searchRoles"),{body:e},t,function(e,t){var o;if(e)return r(e);o=t.result.hits.map(function(e){return new n(i,e._id,e._source,e._meta)}),r(null,{total:t.result.total,roles:o})})},s.prototype.createRole=function(e,t,r,i){var o=this,s={},u="createRole";if(!e||"string"!=typeof e)throw new Error("Security.createRole: cannot create a role without a role ID");i||"function"!=typeof r||(i=r,r=null),s._id=e,s.body=t,r&&(u=r.replaceIfExist?"createOrReplaceRole":"createRole"),o.kuzzle.query(this.buildQueryArgs(u),s,r,i&&function(e,t){i(e,e?void 0:new n(o,t.result._id,t.result._source,t.result._meta))})},s.prototype.updateRole=function(e,t,r,i){var o=this,s={_id:e,body:t};if(!e||"string"!=typeof e)throw new Error("Security.updateRole: cannot update a role without a role ID");return i||"function"!=typeof r||(i=r,r=null),o.kuzzle.query(this.buildQueryArgs("updateRole"),s,r,i&&function(r,s){i(r,r?void 0:new n(o,e,t,s.result._meta))}),this},s.prototype.deleteRole=function(e,t,r){var n={_id:e};return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteRole"),n,t,r&&function(e,t){r(e,e?void 0:t.result._id)}),this},s.prototype.role=function(e,t,r){return new n(this,e,t,r)},s.prototype.fetchProfile=function(e,t,r){var n,o=this;if(r||"function"!=typeof t||(r=t,t=null),!e||"string"!=typeof e)throw new Error("Id parameter is mandatory for fetchProfile function");n={_id:e},o.kuzzle.callbackRequired("Security.fetchProfile",r),o.kuzzle.query(this.buildQueryArgs("getProfile"),n,t,function(e,t){r(e,e?void 0:new i(o,t.result._id,t.result._source,t.result._meta))})},s.prototype.searchProfiles=function(e,t,r){var n=this;r||"function"!=typeof t||(r=t,t=null),n.kuzzle.callbackRequired("Security.searchProfiles",r),n.kuzzle.query(this.buildQueryArgs("searchProfiles"),{body:e},t,function(e,t){var o,s;if(e)return r(e);o=t.result.hits.map(function(e){return new i(n,e._id,e._source,e._meta)}),t.result.scrollId&&(s=t.result.scrollId),r(null,{total:t.result.total,profiles:o,scrollId:s})})},s.prototype.createProfile=function(e,t,r,n){var o=this,s={},u="createProfile";if(!e||"string"!=typeof e)throw new Error("Security.createProfile: cannot create a profile without a profile ID");n||"function"!=typeof r||(n=r,r=null),s._id=e,t&&(s.body={policies:t}),r&&(u=r.replaceIfExist?"createOrReplaceProfile":"createProfile"),o.kuzzle.query(this.buildQueryArgs(u),s,r,n&&function(e,t){n(e,e?void 0:new i(o,t.result._id,t.result._source,t.result._meta))})},s.prototype.updateProfile=function(e,t,r,n){var o=this,s={};if(!e||"string"!=typeof e)throw new Error("Security.updateProfile: cannot update a profile without a profile ID");return n||"function"!=typeof r||(n=r,r=null),s._id=e,t&&(s.body={policies:t}),o.kuzzle.query(this.buildQueryArgs("updateProfile"),s,r,n&&function(e,t){var r={};if(e)return n(e);Object.keys(t.result._source).forEach(function(e){r[e]=t.result._source[e]}),n(null,new i(o,t.result._id,r,t.result._meta))}),this},s.prototype.deleteProfile=function(e,t,r){var n={_id:e};return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteProfile"),n,t,r&&function(e,t){r(e,e?void 0:t.result._id)}),this},s.prototype.scrollProfiles=function(e,t,r){var n={},o=this;if(!e)throw new Error("Security.scrollProfiles: scrollId is required");r||"function"!=typeof t||(r=t,t={}),this.kuzzle.callbackRequired("Security.scrollProfiles",r),n.scrollId=e,t&&t.scroll&&(n.scroll=t.scroll),this.kuzzle.query({controller:"security",action:"scrollProfiles"},n,t,function(t,n){var s=[];if(t)return r(t);n.result.hits.forEach(function(e){var t=new i(o,e._id,e._source,e._meta);t.version=e._version,s.push(t)}),r(null,{total:n.result.total,profiles:s,scrollId:e})})},s.prototype.profile=function(e,t,r){return new i(this,e,t,r)},s.prototype.fetchUser=function(e,t,r){var n={_id:e},i=this;if(!e||"string"!=typeof e)throw new Error("Id parameter is mandatory for fetchUser function");r||"function"!=typeof t||(r=t,t=null),i.kuzzle.callbackRequired("Security.fetchUser",r),i.kuzzle.query(this.buildQueryArgs("getUser"),n,t,function(e,t){r(e,e?void 0:new o(i,t.result._id,t.result._source,t.result._meta))})},s.prototype.searchUsers=function(e,t,r){var n=this;r||"function"!=typeof t||(r=t,t=null),n.kuzzle.callbackRequired("Security.searchUsers",r),n.kuzzle.query(this.buildQueryArgs("searchUsers"),{body:e},t,function(e,t){var i,s=null;if(e)return r(e);i=t.result.hits.map(function(e){return new o(n,e._id,e._source,e._meta)}),t.result.scrollId&&(s=t.result.scrollId),r(null,{total:t.result.total,users:i,scrollId:s})})},s.prototype.createUser=function(e,t,r,n){var i=this,s={_id:e,body:t};n||"function"!=typeof r||(n=r,r=null),i.kuzzle.query(i.buildQueryArgs("createUser"),s,null,n&&function(e,t){n(e,e?void 0:new o(i,t.result._id,t.result._source,t.result._meta))})},s.prototype.replaceUser=function(e,t,r,n){var i=this,s={_id:e,body:t};if(!e||"string"!=typeof e)throw new Error("Security.replaceUser: cannot replace a user without a user ID");n||"function"!=typeof r||(n=r,r=null),i.kuzzle.query(this.buildQueryArgs("replaceUser"),s,r,n&&function(e,t){n(e,e?void 0:new o(i,t.result._id,t.result._source,t.result._meta))})},s.prototype.createRestrictedUser=function(e,t,r,n){var i=this,s={_id:e,body:t};if(t.profileIds)throw new Error("Security.createRestrictedUser: cannot provide profileIds");n||"function"!=typeof r||(n=r,r=null),i.kuzzle.query(this.buildQueryArgs("createRestrictedUser"),s,null,n&&function(e,t){n(e,e?void 0:new o(i,t.result._id,t.result._source))})},s.prototype.updateUser=function(e,t,r,n){var i=this,s={};if(!e||"string"!=typeof e)throw new Error("Security.updateUser: cannot update an user without an user ID");return n||"function"!=typeof r||(n=r,r=null),s._id=e,s.body=t,i.kuzzle.query(this.buildQueryArgs("updateUser"),s,r,n&&function(e,t){n(e,e?void 0:new o(i,t.result._id,t.result._source,t.result._meta))}),this},s.prototype.deleteUser=function(e,t,r){var n={_id:e};return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteUser"),n,t,r&&function(e,t){r(e,e?void 0:t.result._id)}),this},s.prototype.scrollUsers=function(e,t,r){var n={},i=this;if(!e)throw new Error("Security.scrollUsers: scrollId is required");return r||"function"!=typeof t||(r=t,t={}),this.kuzzle.callbackRequired("Security.scrollUsers",r),n.scrollId=e,t&&t.scroll&&(n.scroll=t.scroll),this.kuzzle.query({controller:"security",action:"scrollUsers"},n,t,function(t,n){var s=[];if(t)return r(t);n.result.hits.forEach(function(e){var t=new o(i,e._id,e._source,e._meta);t.version=e._version,s.push(t)}),r(null,{total:n.result.total,users:s,scrollId:e})}),this},s.prototype.user=function(e,t,r){return new o(this,e,t,r)},s.prototype.isActionAllowed=function(e,t,r,n,i){var o;if(!e||"object"!=typeof e)throw new Error("rights parameter is mandatory for isActionAllowed function");if(!t||"string"!=typeof t)throw new Error("controller parameter is mandatory for isActionAllowed function");if(!r||"string"!=typeof r)throw new Error("action parameter is mandatory for isActionAllowed function");return(o=e.filter(function(e){return e.controller===t||"*"===e.controller}).filter(function(e){return e.action===r||"*"===e.action}).filter(function(e){return e.index===n||"*"===e.index}).filter(function(e){return e.collection===i||"*"===e.collection})).some(function(e){return"allowed"===e.value})?"allowed":o.some(function(e){return"conditional"===e.value})?"conditional":"denied"},s.prototype.getUserRights=function(e,t,r){var n={_id:e};if(!e||"string"!=typeof e)throw new Error("userId parameter is mandatory for getUserRights function");r||"function"!=typeof t||(r=t,t=null),this.kuzzle.callbackRequired("Kuzzle.getUserRights",r),this.kuzzle.query(this.buildQueryArgs("getUserRights"),n,t,r&&function(e,t){r(e,e?void 0:t.result.hits)})},s.prototype.createCredentials=function(e,t,r,n,i){return i||"function"!=typeof n||(i=n,n=null),this.kuzzle.query({controller:"security",action:"createCredentials"},{_id:t,strategy:e,body:r},n,function(e,t){e?i&&i(e):i&&i(null,t.result._source)}),this},s.prototype.deleteCredentials=function(e,t,r,n){return n||"function"!=typeof r||(n=r,r=null),this.kuzzle.query({controller:"security",action:"deleteCredentials"},{strategy:e,_id:t},r,"function"!=typeof n?null:function(e,t){e?n&&n(e):n&&n(null,t.result)}),this},s.prototype.getAllCredentialFields=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.kuzzle.query({controller:"security",action:"getAllCredentialFields"},{},e,"function"!=typeof t?null:function(e,r){e?t&&t(e):t&&t(null,r.result)})},s.prototype.getCredentialFields=function(e,t,r){r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query({controller:"security",action:"getCredentialFields"},{strategy:e},t,"function"!=typeof r?null:function(e,t){e?r&&r(e):r&&r(null,t.result)})},s.prototype.getCredentials=function(e,t,r,n){n||"function"!=typeof r||(n=r,r=null),this.kuzzle.query({controller:"security",action:"getCredentials"},{strategy:e,_id:t},r,"function"!=typeof n?null:function(e,t){e?n&&n(e):n&&n(null,t.result)})},s.prototype.hasCredentials=function(e,t,r,n){n||"function"!=typeof r||(n=r,r=null),this.kuzzle.query({controller:"security",action:"hasCredentials"},{strategy:e,_id:t},r,"function"!=typeof n?null:function(e,t){e?n&&n(e):n&&n(null,t.result)})},s.prototype.updateCredentials=function(e,t,r,n,i){return i||"function"!=typeof n||(i=n,n=null),this.kuzzle.query({controller:"security",action:"updateCredentials"},{strategy:e,_id:t,body:r},n,"function"!=typeof i?null:function(e,t){e?i&&i(e):i&&i(null,t.result)}),this},s.prototype.validateCredentials=function(e,t,r,n,i){i||"function"!=typeof n||(i=n,n=null),this.kuzzle.query({controller:"security",action:"validateCredentials"},{strategy:e,_id:t,body:r},n,"function"!=typeof i?null:function(e,t){e?i&&i(e):i&&i(null,t.result)})},e.exports=s},function(e,t,r){var n=r(0);function i(e,t,r,i){if(n.call(this,e,t,r,i),Object.defineProperties(this,{deleteActionName:{value:"deleteRole"},updateActionName:{value:"updateRole"}}),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["save"].indexOf(e)}})}i.prototype=Object.create(n.prototype,{constructor:{value:i}}),i.prototype.save=function(e,t){var r=this.serialize(),n=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),n.kuzzle.query(this.Security.buildQueryArgs("createOrReplaceRole"),r,e,t&&function(e){t(e,e?void 0:n)}),this},e.exports=i},function(e,t,r){var n=r(0);function i(e,t,r,i){if(n.call(this,e,t,r,i),Object.defineProperties(this,{deleteActionName:{value:"deleteProfile"},updateActionName:{value:"updateProfile"}}),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["hydrate","save"].indexOf(e)}})}i.prototype=Object.create(n.prototype,{constructor:{value:i}}),i.prototype.save=function(e,t){var r,n=this;if(!this.content.policies)throw new Error('Argument "policies" is mandatory in a profile. This argument contains an array of objects.');return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),r=this.serialize(),n.kuzzle.query(n.Security.buildQueryArgs("createOrReplaceProfile"),r,e,t&&function(e){t(e,e?void 0:n)}),n},i.prototype.addPolicy=function(e){if("object"!=typeof e||"string"!=typeof e.roleId)throw new Error('Parameter "policies" must be an object containing at least a "roleId" member which must be a string.');return this.content.policies||(this.content.policies=[]),this.content.policies.push(e),this},i.prototype.setPolicies=function(e){if(!Array.isArray(e))throw new Error('Parameter "policies" must be an array of objects containing at least a "roleId" member which must be a string');return e.map(function(e){if("object"!=typeof e||"string"!=typeof e.roleId)throw new Error('Parameter "policies" must be an array of objects containing at least a "roleId" member which must be a string')}),this.content.policies=e,this},i.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),e.body=this.content,e.meta=this.meta,e},i.prototype.getPolicies=function(){return this.content.policies},e.exports=i},function(e,t){var r={getter:!0,required:["_id"]},n={getter:!0,required:["_id","field"]},i={getter:!0,required:["keys"]},o={getter:!0,required:["_id","member"]},s={getter:!0,required:["_id","cursor"],opts:["match","count"],mapResults:w},u={getter:!0,required:["_id","start","stop"],opts:v,mapResults:g},l={getter:!0,required:["_id","min","max"],opts:v,mapResults:g},c={required:["_id"]},a={required:["_id","value"]},f={required:["_id","field","value"]},d={required:["entries"]},h={append:a,bitcount:{getter:!0,required:["_id"],opts:["start","end"]},bitop:{required:["_id","operation","keys"]},bitpos:{getter:!0,required:["_id","bit"],opts:["start","end"]},dbsize:{getter:!0},decr:c,decrby:a,del:{required:["keys"]},exists:i,expire:{required:["_id","seconds"]},expireat:{required:["_id","timestamp"]},flushdb:{},geoadd:{required:["_id","points"]},geodist:{getter:!0,required:["_id","member1","member2"],opts:["unit"],mapResults:parseFloat},geohash:{getter:!0,required:["_id","members"]},geopos:{getter:!0,required:["_id","members"],mapResults:function(e){return e.map(function(e){return e.map(function(e){return parseFloat(e)})})}},georadius:{getter:!0,required:["_id","lon","lat","distance","unit"],opts:b,mapResults:m},georadiusbymember:{getter:!0,required:["_id","member","distance","unit"],opts:b,mapResults:m},get:r,getbit:{getter:!0,required:["_id","offset"]},getrange:{getter:!0,required:["_id","start","end"]},getset:a,hdel:{required:["_id","fields"]},hexists:n,hget:n,hgetall:{getter:!0,required:["_id"]},hincrby:f,hincrbyfloat:{required:["_id","field","value"],mapResults:parseFloat},hkeys:r,hlen:r,hmget:{getter:!0,required:["_id","fields"]},hmset:{required:["_id","entries"]},hscan:s,hset:f,hsetnx:f,hstrlen:n,hvals:r,incr:c,incrby:a,incrbyfloat:{required:["_id","value"],mapResults:parseFloat},keys:{getter:!0,required:["pattern"]},lindex:{getter:!0,required:["_id","idx"]},linsert:{required:["_id","position","pivot","value"]},llen:r,lpop:c,lpush:{required:["_id","values"]},lpushx:a,lrange:{getter:!0,required:["_id","start","stop"]},lrem:{required:["_id","count","value"]},lset:{required:["_id","index","value"]},ltrim:{required:["_id","start","stop"]},mget:i,mset:d,msetnx:d,object:{getter:!0,required:["_id","subcommand"]},persist:c,pexpire:{required:["_id","milliseconds"]},pexpireat:{required:["_id","timestamp"]},pfadd:{required:["_id","elements"]},pfcount:i,pfmerge:{required:["_id","sources"]},ping:{getter:!0},psetex:{required:["_id","value","milliseconds"]},pttl:r,randomkey:{getter:!0},rename:{required:["_id","newkey"]},renamenx:{required:["_id","newkey"]},rpop:c,rpoplpush:{required:["source","destination"]},rpush:{required:["_id","values"]},rpushx:a,sadd:{required:["_id","members"]},scan:{getter:!0,required:["cursor"],opts:["match","count"],mapResults:w},scard:r,sdiff:{getter:!0,required:["_id","keys"]},sdiffstore:{required:["_id","keys","destination"]},set:{required:["_id","value"],opts:["ex","px","nx","xx"]},setex:{required:["_id","value","seconds"]},setnx:a,sinter:i,sinterstore:{required:["destination","keys"]},sismember:o,smembers:r,smove:{required:["_id","destination","member"]},sort:{required:["_id"],opts:["alpha","by","direction","get","limit"]},spop:{required:["_id"],opts:["count"],mapResults:z},srandmember:{getter:!0,required:["_id"],opts:["count"],mapResults:z},srem:{required:["_id","members"]},sscan:s,strlen:r,sunion:i,sunionstore:{required:["destination","keys"]},time:{getter:!0,mapResults:function(e){return e.map(function(e){return parseInt(e)})}},touch:{required:["keys"]},ttl:r,type:r,zadd:{required:["_id","elements"],opts:["nx","xx","ch","incr"]},zcard:r,zcount:{getter:!0,required:["_id","min","max"]},zincrby:{required:["_id","member","value"]},zinterstore:{required:["_id","keys"],opts:["weights","aggregate"]},zlexcount:{getter:!0,required:["_id","min","max"]},zrange:u,zrangebylex:{getter:!0,required:["_id","min","max"],opts:["limit"]},zrevrangebylex:{getter:!0,required:["_id","min","max"],opts:["limit"]},zrangebyscore:l,zrank:o,zrem:{required:["_id","members"]},zremrangebylex:{required:["_id","min","max"]},zremrangebyrank:{required:["_id","start","stop"]},zremrangebyscore:{required:["_id","min","max"]},zrevrange:u,zrevrangebyscore:l,zrevrank:o,zscan:s,zscore:{getter:!0,required:["_id","member"],mapResults:parseFloat},zunionstore:{required:["_id","keys"],opts:["weights","aggregate"]}};function p(e){return Object.defineProperties(this,{kuzzle:{value:e,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0}}),this.setHeaders=e.setHeaders.bind(this),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1===["setHeaders"].indexOf(e)}}):this}function y(e,t,r,n){t||"_id"===r?e[r]=n:e.body[r]=n}function b(e,t){var r=[];Object.keys(t).filter(function(e){return t[e]&&-1!==["withcoord","withdist","count","sort"].indexOf(e)}).forEach(function(e){"withcoord"===e||"withdist"===e?(r.push(e),delete t[e]):"count"!==e&&"sort"!==e||("count"===e&&r.push("count"),r.push(t[e])),delete t[e]}),r.length>0&&(e.options=r)}function v(e,t){e.options=["withscores"],t.limit&&(e.limit=t.limit,delete t.limit)}function m(e){return Array.isArray(e[0])?e.map(function(e){var t,r={name:e[0]};for(t=1;t<e.length;t++)Array.isArray(e[t])?r.coordinates=e[t].map(function(e){return parseFloat(e)}):r.distance=parseFloat(e[t]);return r}):e.map(function(e){return{name:e}})}function z(e){return Array.isArray(e)?e:[e]}function g(e){var t=null,r=[];return e.forEach(function(e){null===t?t=e:(r.push({member:t,score:parseFloat(e)}),t=null)}),r}function w(e){return{cursor:e[0],values:e[1]}}Object.keys(h).forEach(function(e){p.prototype[e]=function(){var t,r=Array.prototype.slice.call(arguments),n=null,i={controller:"ms",action:e},o={};if(r.length&&"function"==typeof r[r.length-1]&&(t=r.pop()),h[e].getter&&this.kuzzle.callbackRequired("MemoryStorage."+e,t),h[e].getter||(o.body={}),h[e].required&&h[e].required.forEach(function(t){var n=r.shift();if(void 0===n)throw new Error("MemoryStorage."+e+': Missing parameter "'+t+'"');y(o,h[e].getter,t,n)}),r.length>1)throw new Error("MemoryStorage."+e+": Too many parameters provided");if(1===r.length&&"object"!=typeof r[0]||Array.isArray(r[0]))throw new Error("MemoryStorage."+e+": Invalid optional parameter (expected an object)");if(r.length&&(n=Object.assign({},r[0]),Array.isArray(h[e].opts)&&h[e].opts.forEach(function(t){null!==n[t]&&void 0!==n[t]&&(y(o,h[e].getter,t,n[t]),delete n[t])})),"function"==typeof h[e].opts&&h[e].opts(o,n||{}),this.kuzzle.query(i,o,n,t&&function(r,n){return r?t(r):h[e].mapResults?t(null,h[e].mapResults(n.result)):void t(null,n.result)}),!h[e].getter)return this}}),e.exports=p},function(e,t,r){e.exports=function(e,t,n){if("undefined"!=typeof window){if("undefined"!=typeof WebSocket)return new(r(5))(e,t,n);if(window.io)return new(r(20))(e,t,n);throw new Error("Aborting: no websocket support detected and no socket.io library loaded either.")}return new(r(5))(e,t,n)}},function(e,t){function r(e,t,r,n){!t||e.retrying||e.stopRetryingToConnect||(e.retrying=!0,setTimeout(function(){e.retrying=!1,e.connect(t,r)},r)),e.handlers.connectError.forEach(function(e){e(n)})}e.exports=function(e,t,n){this.host=e,this.port=t,this.ssl=n,this.socket=null,this.wasConnected=!1,this.forceDisconnect=!1,this.handlers={connect:[],reconnect:[],connectError:[],disconnect:[]},this.retrying=!1,this.connect=function(e,t){var n=this;this.socket=window.io((this.ssl?"https://":"http://")+this.host+":"+this.port,{reconnection:e,reconnectionDelay:t,forceNew:!0}),this.socket.on("connect",function(){n.wasConnected?n.handlers.reconnect.forEach(function(e){e()}):n.handlers.connect.forEach(function(e){e()}),n.wasConnected=!0}),this.socket.on("connect_error",function(i){r(n,e,t,i)}),this.socket.on("disconnect",function(){var i;n.forceDisconnect?n.handlers.disconnect.forEach(function(e){e()}):((i=new Error("An error occurred, this may due that kuzzle was not ready yet")).status=500,r(n,e,t,i)),n.forceDisconnect=!1})},this.onConnect=function(e){-1===this.handlers.connect.indexOf(e)&&this.handlers.connect.push(e)},this.onConnectError=function(e){-1===this.handlers.connectError.indexOf(e)&&this.handlers.connectError.push(e)},this.onDisconnect=function(e){-1===this.handlers.disconnect.indexOf(e)&&this.handlers.disconnect.push(e)},this.onReconnect=function(e){-1===this.handlers.reconnect.indexOf(e)&&this.handlers.reconnect.push(e)},this.once=function(e,t){this.socket.once(e,t)},this.on=function(e,t){this.socket.on(e,t)},this.off=function(e,t){this.socket.off(e,t)},this.send=function(e){this.socket.emit("kuzzle",e)},this.close=function(){this.forceDisconnect=!0,this.socket.close(),this.socket=null}}}])});
//# sourceMappingURL=kuzzle.js.map